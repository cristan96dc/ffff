{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registrar Venta</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #0d6efd;
            border-top: none;
            max-height: 250px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 0 0 8px 8px;
        }
        .autocomplete-suggestion {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }
        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.active {
            background: #0d6efd;
            color: white;
        }
        .autocomplete-suggestion:hover .suggestion-detail,
        .autocomplete-suggestion.active .suggestion-detail {
            color: #e7f3ff;
        }
        .suggestion-main {
            font-weight: 600;
            font-size: 1.05em;
            color: #212529;
        }
        .autocomplete-suggestion:hover .suggestion-main,
        .autocomplete-suggestion.active .suggestion-main {
            color: white;
        }
        .suggestion-detail {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 4px;
        }
        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            border-radius: 8px 8px 0 0;
        }
        .no-suggestions {
            padding: 12px 15px;
            color: #6c757d;
            font-style: italic;
            text-align: center;
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-5">
    <div class="lista-header text-center mb-4">
        <h1>üí∏ Registrar Venta</h1>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
    
    <div class="card p-4 shadow">
        <form method="POST" id="ventaForm">
            {% csrf_token %}
            
            <div class="form-group mb-4">
                <label for="producto_search" class="form-label fw-bold">Producto *</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="producto_search" 
                        class="form-control form-control-lg" 
                        placeholder="Empiece a escribir el nombre del producto..."
                        autocomplete="off"
                        required>
                    <div id="producto_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <input type="hidden" name="producto" id="producto_id" required>
                <small class="form-text text-muted mt-2 d-block" id="producto_info"></small>
            </div>
            
            <div class="form-group mb-4">
                <label for="cliente_search" class="form-label fw-bold">Cliente (Opcional)</label>
                <div class="autocomplete-container">
                    <input 
                        type="text" 
                        id="cliente_search" 
                        class="form-control form-control-lg" 
                        placeholder="Deje vac√≠o para venta sin cliente o escriba para buscar..."
                        autocomplete="off">
                    <div id="cliente_suggestions" class="autocomplete-suggestions"></div>
                </div>
                <input type="hidden" name="cliente" id="cliente_id">
                <small class="form-text text-muted mt-2 d-block">
                    <a href="{% url 'crear_cliente' %}" target="_blank" class="text-decoration-none">
                        ‚ûï ¬øCliente nuevo? Registrar aqu√≠
                    </a>
                </small>
            </div>
            
            <div class="form-group mb-4">
                <label for="cantidad" class="form-label fw-bold">Cantidad vendida *</label>
                <input type="number" name="cantidad" id="cantidad" class="form-control form-control-lg" min="1" required>
                <small class="form-text text-muted mt-2 d-block" id="cantidad_info"></small>
            </div>
            
            <div class="alert alert-info d-none" id="total_estimado">
                <h5 class="mb-0">üí∞ <strong>Total estimado:</strong> $<span id="total_valor">0.00</span></h5>
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="btn_submit">
                    ‚úÖ Registrar Venta
                </button>
                <a href="{% url 'home' %}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
    // Datos de productos
    const productos = [
        {% for p in productos %}
        {
            id: {{ p.id }},
            nombre: "{{ p.nombre|escapejs }}",
            stock: {{ p.cantidad }},
            valor: parseFloat("{{ p.valor }}")
        }{% if not forloop.last %},{% endif %}  {% endfor %}
    ];
    
    // Datos de clientes
    const clientes = [
        {% for c in clientes %}
        {
            id: {{ c.id }},
            nombre: "{{ c.nombre_completo|escapejs }}",
            local: "{{ c.nombre_local|default:''|escapejs }}"
        }{% if not forloop.last %},{% endif %}  {% endfor %}
    ];
    
    let productoSeleccionado = null;
    let productoSelectedIndex = -1;
    let clienteSelectedIndex = -1;
    
    // Referencias a elementos
    const productoSearch = document.getElementById('producto_search');
    const productoId = document.getElementById('producto_id');
    const productoInfo = document.getElementById('producto_info');
    const productoSuggestions = document.getElementById('producto_suggestions');
    
    const clienteSearch = document.getElementById('cliente_search');
    const clienteId = document.getElementById('cliente_id');
    const clienteSuggestions = document.getElementById('cliente_suggestions');
    
    const cantidadInput = document.getElementById('cantidad');
    const cantidadInfo = document.getElementById('cantidad_info');
    const totalEstimado = document.getElementById('total_estimado');
    const totalValor = document.getElementById('total_valor');
    const btnSubmit = document.getElementById('btn_submit');
    
    // ============== AUTOCOMPLETADO DE PRODUCTOS ==============
    productoSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        productoSuggestions.innerHTML = '';
        productoSelectedIndex = -1;
        
        if (query.length === 0) {
            productoSuggestions.style.display = 'none';
            productoSeleccionado = null;
            productoId.value = '';
            productoInfo.textContent = '';
            productoInfo.className = 'form-text text-muted mt-2 d-block';
            totalEstimado.classList.add('d-none');
            return;
        }
        
        const filtered = productos.filter(p => 
            p.nombre.toLowerCase().includes(query)
        );
        
        if (filtered.length > 0) {
            filtered.forEach((producto, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.innerHTML = `
                    <div class="suggestion-main">${producto.nombre}</div>
                    <div class="suggestion-detail">üì¶ Stock: ${producto.stock} unidades | üíµ Precio: $${producto.valor.toFixed(2)}</div>
                `;
                div.addEventListener('click', () => seleccionarProducto(producto));
                productoSuggestions.appendChild(div);
            });
            productoSuggestions.style.display = 'block';
        } else {
            productoSuggestions.innerHTML = '<div class="no-suggestions">‚ùå No se encontraron productos</div>';
            productoSuggestions.style.display = 'block';
        }
    });
    
    productoSearch.addEventListener('focus', function() {
        if (this.value.trim() && productoSuggestions.children.length > 0) {
            productoSuggestions.style.display = 'block';
        }
    });
    
    function seleccionarProducto(producto) {
        productoSearch.value = producto.nombre;
        productoId.value = producto.id;
        productoSeleccionado = producto;
        productoSuggestions.style.display = 'none';
        productoInfo.innerHTML = `‚úÖ <strong>Stock disponible:</strong> ${producto.stock} unidades | <strong>Precio:</strong> $${producto.valor.toFixed(2)}`;
        productoInfo.className = 'form-text text-success mt-2 d-block fw-bold';
        calcularTotal();
        validarStock();
    }
    
    // ============== AUTOCOMPLETADO DE CLIENTES ==============
    clienteSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        clienteSuggestions.innerHTML = '';
        clienteSelectedIndex = -1;
        
        if (query.length === 0) {
            clienteSuggestions.style.display = 'none';
            clienteId.value = '';
            return;
        }
        
        const filtered = clientes.filter(c => 
            c.nombre.toLowerCase().includes(query) || 
            c.local.toLowerCase().includes(query)
        );
        
        if (filtered.length > 0) {
            filtered.forEach((cliente, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.innerHTML = `
                    <div class="suggestion-main">üë§ ${cliente.nombre}</div>
                    ${cliente.local ? `<div class="suggestion-detail">üè™ Local: ${cliente.local}</div>` : '<div class="suggestion-detail">Sin local registrado</div>'}
                `;
                div.addEventListener('click', () => seleccionarCliente(cliente));
                clienteSuggestions.appendChild(div);
            });
            clienteSuggestions.style.display = 'block';
        } else {
            clienteSuggestions.innerHTML = '<div class="no-suggestions">‚ùå No se encontraron clientes</div>';
            clienteSuggestions.style.display = 'block';
        }
    });
    
    clienteSearch.addEventListener('focus', function() {
        if (this.value.trim() && clienteSuggestions.children.length > 0) {
            clienteSuggestions.style.display = 'block';
        }
    });
    
    function seleccionarCliente(cliente) {
        clienteSearch.value = cliente.nombre;
        clienteId.value = cliente.id;
        clienteSuggestions.style.display = 'none';
    }
    
    // ============== NAVEGACI√ìN CON TECLADO ==============
    productoSearch.addEventListener('keydown', function(e) {
        handleKeyboardNavigation(e, productoSuggestions, 'producto');
    });
    
    clienteSearch.addEventListener('keydown', function(e) {
        handleKeyboardNavigation(e, clienteSuggestions, 'cliente');
    });
    
    function handleKeyboardNavigation(e, container, tipo) {
        const suggestions = container.querySelectorAll('.autocomplete-suggestion:not(.no-suggestions)');
        if (suggestions.length === 0) return;
        
        let selectedIndex = tipo === 'producto' ? productoSelectedIndex : clienteSelectedIndex;
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
            updateSelection(suggestions, selectedIndex);
            if (tipo === 'producto') productoSelectedIndex = selectedIndex;
            else clienteSelectedIndex = selectedIndex;
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            updateSelection(suggestions, selectedIndex);
            if (tipo === 'producto') productoSelectedIndex = selectedIndex;
            else clienteSelectedIndex = selectedIndex;
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            suggestions[selectedIndex].click();
        } else if (e.key === 'Escape') {
            container.style.display = 'none';
        }
    }
    
    function updateSelection(suggestions, selectedIndex) {
        suggestions.forEach((s, i) => {
            s.classList.toggle('active', i === selectedIndex);
        });
        if (selectedIndex >= 0 && suggestions[selectedIndex]) {
            suggestions[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
    }
    
    // ============== C√ÅLCULOS Y VALIDACIONES ==============
    cantidadInput.addEventListener('input', function() {
        calcularTotal();
        validarStock();
    });
    
    function calcularTotal() {
        if (productoSeleccionado && cantidadInput.value > 0) {
            const cantidad = parseInt(cantidadInput.value);
            const total = productoSeleccionado.valor * cantidad;
            totalValor.textContent = total.toFixed(2);
            totalEstimado.classList.remove('d-none');
        } else {
            totalEstimado.classList.add('d-none');
        }
    }
    
    function validarStock() {
        if (productoSeleccionado && cantidadInput.value > 0) {
            const cantidad = parseInt(cantidadInput.value);
            if (cantidad > productoSeleccionado.stock) {
                cantidadInfo.innerHTML = `‚ö†Ô∏è <strong>ERROR:</strong> Solo hay ${productoSeleccionado.stock} unidades disponibles`;
                cantidadInfo.className = 'form-text text-danger mt-2 d-block fw-bold';
                btnSubmit.disabled = true;
            } else {
                cantidadInfo.innerHTML = `‚úÖ <strong>Cantidad disponible</strong>`;
                cantidadInfo.className = 'form-text text-success mt-2 d-block fw-bold';
                btnSubmit.disabled = false;
            }
        }
    }
    
    // ============== CERRAR SUGERENCIAS AL HACER CLIC FUERA ==============
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-container')) {
            productoSuggestions.style.display = 'none';
            clienteSuggestions.style.display = 'none';
        }
    });
    
    // ============== VALIDACI√ìN DEL FORMULARIO ==============
    document.getElementById('ventaForm').addEventListener('submit', function(e) {
        if (!productoId.value) {
            e.preventDefault();
            alert('‚ùå Por favor seleccione un producto v√°lido de las sugerencias');
            productoSearch.focus();
            return false;
        }
        // Cliente es OPCIONAL - no validamos
        if (productoSeleccionado && parseInt(cantidadInput.value) > productoSeleccionado.stock) {
            e.preventDefault();
            alert('‚ùå La cantidad solicitada supera el stock disponible');
            return false;
        }
    });
</script>

<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
</body>
</html>